# hopeful
# cdate=2016/02/15
# ldate=2016/02/15

主页

开发教程
	rovo89于2014年08月13编辑此页面 · 11次修订 ──────────────────────────────────────────────────────────────────────────────
好吧...你想学会如何为Xposed创建一个新的模块？那么阅读本教程（或者我们更愿意称之为“扩展尝试”）并学会如何利用它。这不仅包括技术性的“创建这个文件并插入...”，还有其背后的的思想，这是创造价值的步骤，因此你真的需要理解你在做什么以及为什么做。如果你觉得“太长，不看”，你可以只看最后的源码并阅读“使工程成为一个Xposed模块”一章。如果你阅读整篇教程，你将会更好的理解。你将节省花在阅读后面内容的时间因为你不需要自己弄清楚所有。
修改主题
──────────────────────────────────────────────────────────────────────────────
你将会重新建立同样可以在Github上找到的“red clock”例子。它包括改变状态栏时钟的颜色为红色并添加一个笑脸。我选择这个例子因为它相当小，但有易见的改变。此外，它使用类一些由框架提供的基础方法。
Xposed如何工作
──────────────────────────────────────────────────────────────────────────────
在你开始你的修改之前，你应该大致了解一下Xposed是怎么工作的（如果你觉得过于无聊就跳过这个部分）。原理如下：
有一个被称为“合子”的进程。这是安卓运行环境的核心。每一个应用将作为它的一个副本（由它“孕育”出来）。当手机启动时，这个进程由一个/init.rc脚本启动。这个进程的启动由/system/bin/app_process完成，它加载所需的类并调用初始化方法。

这就是Xposed的用武之地。当你安装了框架，一个扩展的app_process可执行文件背拷贝到/system/bin。这个扩展的启动进程增加了一个额外的jar包到classpath并在特定的地方调用这里的方法。例如，在虚拟机刚创建过，甚至合子的main方法被调用前。在这个方法里，我们是合子的一部分，可以在其上下文中起作用。

jar包位于/data/data/de.robv.android.xposed.installer/bin/XposedBridge.jar，其源码可以在这里（https://github.com/rovo89/XposedBridge）找到.查看XposedBridge类，你可以看到main方法。这是我写在上面的东西，这将会在进程的最开始被调用。一些初始化在这里完成并且模块被加载（后面我将回头讲模块加载）。
方法挂钩/更换

真正使Xposed产生力量的是“钩子”方法调用的可能性。当你通过反编译APK做一些修改，你可以在任何你想的地方直接插入/更改命令。可是，随后你将需要重新编译/签名这个APK并且你只能分发完整的包。有了可以放在Xposed的钩子，你不能修改方法内部的代码（清楚地定义你想在哪里做哪种改变是不可能的）。取而代之，你可以在方法前后加入你自己的代码，方法是Java中可以被清楚地处理的最小单元。

XposedBridage由一个私有的，原生的方法 hookMethodNative。这个方法也在扩展的app_process中被实施。这将会吧方法类型改变为“原生的”并链接这个方法的实现到其自己的原生的泛型方法。这意味着每次钩子的方法被调用，泛型方法将被调用，而不是没有调用者知道它。在这个方法中，Xposed的handleHookMethod方法被调用，忽略方法调用的参数，this引用等。然后这个方法关注调用回调，这个回调已经被这个方法调用注册。那些可以改变调用的参数，改变实例化的/静态的变量，调用其他方法，利用结果做一些事情...或者所有的这些。它是非常灵活的。

好了，理论足够了。现在，我们开始创建一个模块吧！
